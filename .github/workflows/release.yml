# ImageMagick Portable Binary Build Workflow
#
# This workflow builds small, portable ImageMagick binaries for use as Node.js binary wrappers.
# Based on the official ImageMagick release workflow but optimized for minimal bundle size.
#
# Key differences from official:
# - Only Q16-HDRI builds (most common for Node.js usage)
# - tar.gz instead of 7z for cross-platform compatibility
# - Minimal runtime files (no installers, no PerlMagick)
# - No code signing
# - Rolling prerelease to bin-main tag

name: Build ImageMagick Binaries

on:
  workflow_dispatch:
    inputs:
      platform_windows:
        description: "Build Windows binaries"
        type: boolean
        default: true
      platform_linux_glibc:
        description: "Build Linux glibc binaries"
        type: boolean
        default: true
      platform_linux_musl:
        description: "Build Linux musl binaries"
        type: boolean
        default: true
      platform_macos:
        description: "Build macOS binaries"
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGEMAGICK_REPO: https://github.com/ImageMagick/ImageMagick.git
  IMAGEMAGICK_BRANCH: main

jobs:
  # ============================================================================
  # VERSION EXTRACTION
  # Similar to official workflow - extracts version from ImageMagick source
  # ============================================================================
  version:
    name: Get ImageMagick Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}

    steps:
      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      - name: Extract version
        id: version
        run: |
          cd ImageMagick
          version=$(grep -oP "PACKAGE_VERSION='\K[0-9\.-]*" configure | head -1)
          commit=$(git rev-parse --short HEAD)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "commit=$commit" >> $GITHUB_OUTPUT
          echo "ImageMagick version: $version (commit: $commit)"

  # ============================================================================
  # WINDOWS BUILDS
  # Uses official ImageMagick Windows build scripts from their repo
  # Only x64 and x86 architectures (no arm64)
  # ============================================================================
  windows:
    name: Windows ${{ matrix.arch }}
    runs-on: windows-2025
    needs: version
    if: github.event.inputs.platform_windows != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [x64, x86]

    steps:
      - name: Clone this repo (for release context)
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      # Official build step: download configure tool
      - name: Download configure
        shell: cmd
        run: |
          ImageMagick\.github\build\windows\download-configure.cmd

      # Official build step: download dependencies
      # Uses static build with linked runtime for portability
      - name: Download dependencies
        shell: cmd
        run: |
          ImageMagick\.github\build\windows\download-dependencies.cmd windows-${{ matrix.arch }}-static-openMP-linked-runtime.zip

      # Official build step: run configure
      # Enable all necessary image format delegates:
      # /png - PNG support (libpng)
      # /jpeg - JPEG support (libjpeg-turbo)
      # /webp - WebP support
      # /heic - HEIF/HEIC support
      # /openjp2 - JPEG2000 support (OpenJPEG)
      # /tiff - TIFF support
      # /xml - XML support (for SVG, etc.)
      # /gs - Ghostscript support (for PDF, PS, EPS)
      - name: Configure ImageMagick
        shell: cmd
        working-directory: Configure
        run: |
          Configure.Release.x64.exe /noWizard /VS2022 /hdri /Q16 /${{ matrix.arch }} /static /linkRuntime /png /jpeg /webp /heic /openjp2 /tiff /xml /gs

      # Official build step: build with msbuild
      - name: Build ImageMagick
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          msbuild /m /t:Rebuild /p:Configuration=Release,Platform=${{ matrix.arch }}

      # Verify format support after build
      - name: Verify format support
        shell: pwsh
        run: |
          echo "=== ImageMagick Version ==="
          & "Artifacts\bin\magick.exe" -version | Select-Object -First 10

          echo "`n=== Delegates (Format Support) ==="
          & "Artifacts\bin\magick.exe" -version | Select-String -Pattern "Delegates"

          echo "`n=== Supported Formats ==="
          & "Artifacts\bin\magick.exe" -list format | Select-String -Pattern "PNG|JPEG|JPG|WEBP|HEIC|PDF|TIFF|JP2"

          # Fail if PNG is not supported
          $delegates = & "Artifacts\bin\magick.exe" -version | Select-String -Pattern "Delegates" | Out-String
          if ($delegates -notmatch "png") {
            Write-Error "PNG support not found! Build may be incomplete."
            exit 1
          }
          echo "`n✓ PNG support verified"

      # Package minimal portable bundle (differs from official - smaller bundle)
      - name: Create portable bundle
        shell: pwsh
        env:
          VERSION: ${{ needs.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          $bundleDir = "imagemagick-$env:VERSION-windows-$env:ARCH"
          New-Item -Name $bundleDir -ItemType directory
          New-Item -Name "$bundleDir\bin" -ItemType directory

          # Core executable
          Copy-Item "Artifacts\bin\magick.exe" "$bundleDir\bin"

          # Required config files
          Copy-Item "Artifacts\bin\*.xml" "$bundleDir\bin"
          Copy-Item "Artifacts\bin\sRGB.icc" "$bundleDir\bin"

          # License
          Copy-Item "Artifacts\NOTICE.txt" $bundleDir -ErrorAction SilentlyContinue
          Copy-Item "ImageMagick\LICENSE" "$bundleDir\LICENSE.txt" -ErrorAction SilentlyContinue

          # Verify build
          & "$bundleDir\bin\magick.exe" -version

          # Create tarball
          tar -czvf "$bundleDir.tar.gz" $bundleDir

          # Generate SHA256
          $hash = (Get-FileHash -Algorithm SHA256 "$bundleDir.tar.gz").Hash.ToLower()
          "$hash  $bundleDir.tar.gz" | Out-File -Encoding ASCII "$bundleDir.sha256"

          echo "Created: $bundleDir.tar.gz"
          Get-ChildItem "$bundleDir.*"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-windows-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # LINUX BUILDS (GLIBC)
  # Ubuntu-based builds for standard glibc systems
  # Uses QEMU for arm64 cross-compilation
  # ============================================================================
  linux-glibc:
    name: Linux glibc ${{ matrix.arch }}
    runs-on: ubuntu-24.04
    needs: version
    if: github.event.inputs.platform_linux_glibc != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Set up QEMU (for arm64)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build in container
        run: |
          docker run --rm \
            --platform linux/${{ matrix.arch }} \
            -v ${{ github.workspace }}:/workspace \
            -e VERSION="${{ needs.version.outputs.version }}" \
            -e ARCH="${{ matrix.arch }}" \
            ubuntu:22.04 \
            /bin/bash -c '
              set -ex

              export DEBIAN_FRONTEND=noninteractive
              apt-get update -y

              # Install build essentials (following official oss-fuzz approach)
              apt-get install -y \
                autoconf automake autopoint binutils cmake gettext git gperf g++ \
                libtool locales make nasm pkg-config curl ca-certificates

              export WORK=/opt/deps
              export SRC=/tmp/src
              mkdir -p $WORK $SRC

              # ============================================================
              # Build all dependencies from source as static libraries
              # Based on ImageMagick official oss-fuzz/build_dependencies.sh
              # ============================================================

              # Build zlib
              cd $SRC
              curl -sL https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz | tar xz
              cd zlib-1.3.1
              CFLAGS="-fPIC" ./configure --prefix=$WORK --static
              make -j$(nproc)
              make install

              # Build libdeflate
              cd $SRC
              curl -sL https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.19.tar.gz | tar xz
              cd libdeflate-1.19
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DLIBDEFLATE_BUILD_SHARED_LIB=false -DLIBDEFLATE_BUILD_GZIP=false
              make -j$(nproc)
              make install

              # Build xz/lzma
              cd $SRC
              curl -sL https://github.com/tukaani-project/xz/releases/download/v5.4.5/xz-5.4.5.tar.gz | tar xz
              cd xz-5.4.5
              ./configure --prefix=$WORK --disable-shared --enable-static --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc --with-pic
              make -j$(nproc)
              make install

              # Build zstd
              cd $SRC
              curl -sL https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz | tar xz
              cd zstd-1.5.5
              CFLAGS="-fPIC" make -j$(nproc) lib-release
              make install PREFIX=$WORK

              # Build libpng
              cd $SRC
              curl -sL https://github.com/pnggroup/libpng/archive/refs/tags/v1.6.43.tar.gz | tar xz
              cd libpng-1.6.43
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DPNG_SHARED=false -DPNG_STATIC=true -DCMAKE_C_FLAGS="-fPIC" -DZLIB_INCLUDE_DIR=$WORK/include -DZLIB_LIBRARY=$WORK/lib/libz.a
              make -j$(nproc)
              make install

              # Build libjpeg-turbo
              cd $SRC
              curl -sL https://github.com/libjpeg-turbo/libjpeg-turbo/releases/download/3.0.1/libjpeg-turbo-3.0.1.tar.gz | tar xz
              cd libjpeg-turbo-3.0.1
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_STATIC=true -DENABLE_SHARED=false -DCMAKE_C_FLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build libtiff
              cd $SRC
              curl -sL https://download.osgeo.org/libtiff/tiff-4.6.0.tar.gz | tar xz
              cd tiff-4.6.0
              ./configure --prefix=$WORK --disable-shared --enable-static CFLAGS="-fPIC -I$WORK/include" LDFLAGS="-L$WORK/lib" CPPFLAGS="-I$WORK/include"
              make -j$(nproc)
              make install

              # Build libwebp (use release tarball that includes configure)
              cd $SRC
              curl -sL https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2.tar.gz | tar xz
              cd libwebp-1.3.2
              ./configure --prefix=$WORK --disable-shared --enable-static --disable-png --disable-jpeg --disable-tiff CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build openjpeg
              cd $SRC
              curl -sL https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz | tar xz
              cd openjpeg-2.5.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=false -DBUILD_CODEC=false -DCMAKE_C_FLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build lcms2
              cd $SRC
              curl -sL https://github.com/mm2/Little-CMS/releases/download/lcms2.16/lcms2-2.16.tar.gz | tar xz
              cd lcms2-2.16
              ./configure --prefix=$WORK --disable-shared --enable-static CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build libxml2 (use GNOME download with configure script)
              cd $SRC
              curl -sL https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.3.tar.xz | tar xJ
              cd libxml2-2.12.3
              ./configure --prefix=$WORK --disable-shared --enable-static --without-python --without-icu CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # ============================================================
              # Build ImageMagick with all static dependencies
              # Based on ImageMagick official oss-fuzz/build_imagemagick.sh
              # ============================================================
              cd /workspace
              git clone --depth 1 -b main https://github.com/ImageMagick/ImageMagick.git
              cd ImageMagick

              autoreconf -fiv

              export PKG_CONFIG_PATH="$WORK/lib/pkgconfig:$WORK/lib64/pkgconfig"

              ./configure \
                --prefix=/opt/imagemagick \
                --disable-shared \
                --enable-static \
                --disable-docs \
                --with-quantum-depth=16 \
                --enable-hdri \
                --without-perl \
                --without-magick-plus-plus \
                --with-png \
                --with-jpeg \
                --with-webp \
                --with-tiff \
                --with-openjp2 \
                --with-lcms \
                --with-xml \
                --with-zlib \
                --with-zstd \
                --with-lzma \
                --without-heic \
                --without-gslib \
                --without-x \
                --without-fontconfig \
                --without-freetype \
                --without-djvu \
                --without-fftw \
                --without-fpx \
                --without-dps \
                --without-jbig \
                --without-lqr \
                --without-openexr \
                --without-pango \
                --without-rsvg \
                --without-wmf \
                --without-raw \
                --without-jxl \
                CFLAGS="-fPIC -I$WORK/include" \
                CPPFLAGS="-I$WORK/include" \
                LDFLAGS="-static -L$WORK/lib -L$WORK/lib64" \
                PKG_CONFIG_PATH="$PKG_CONFIG_PATH"

              make -j$(nproc)
              make install

              # Verify the binary works
              echo "=== ImageMagick Version ==="
              /opt/imagemagick/bin/magick -version

              # Check dynamic dependencies
              echo "=== Checking dynamic library dependencies ==="
              ldd /opt/imagemagick/bin/magick 2>&1 || echo "(Static binary)"

              # Smoke test: verify required formats are available
              echo "=== Format Support Check ==="
              for fmt in PNG JPEG WEBP TIFF JP2; do
                if /opt/imagemagick/bin/magick -list format | grep -qi "^[[:space:]]*$fmt"; then
                  echo "✓ $fmt support verified"
                else
                  echo "✗ WARNING: $fmt support not found"
                fi
              done
              
              # Create minimal bundle
              BUNDLE_DIR="/workspace/imagemagick-${VERSION}-linux-glibc-${ARCH}"
              mkdir -p "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib" "$BUNDLE_DIR/etc/ImageMagick-7" "$BUNDLE_DIR/share/ImageMagick-7"
              
              # Copy binary
              cp /opt/imagemagick/bin/magick "$BUNDLE_DIR/bin/"
              
              # Copy required libraries (for non-fully-static builds)
              cp -r /opt/imagemagick/lib/ImageMagick-* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Copy config files
              cp -r /opt/imagemagick/etc/ImageMagick-7/* "$BUNDLE_DIR/etc/ImageMagick-7/" 2>/dev/null || true
              cp -r /opt/imagemagick/share/ImageMagick-7/* "$BUNDLE_DIR/share/ImageMagick-7/" 2>/dev/null || true
              
              # Add license
              cp /workspace/ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"
              
              # Create a wrapper script that sets up environment
              cat > "$BUNDLE_DIR/bin/magick-wrapper.sh" << '\''EOF'\''
                #!/bin/bash
                SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                MAGICK_HOME="$(dirname "$SCRIPT_DIR")"
                export MAGICK_HOME
                export MAGICK_CONFIGURE_PATH="$MAGICK_HOME/etc/ImageMagick-7:$MAGICK_HOME/share/ImageMagick-7"
                export LD_LIBRARY_PATH="$MAGICK_HOME/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
                exec "$SCRIPT_DIR/magick" "$@"
              EOF
              chmod +x "$BUNDLE_DIR/bin/magick-wrapper.sh"
              
              # Create tarball
              cd /workspace
              tar -czvf "${BUNDLE_DIR##*/}.tar.gz" "${BUNDLE_DIR##*/}"
              sha256sum "${BUNDLE_DIR##*/}.tar.gz" > "${BUNDLE_DIR##*/}.sha256"
              
              echo "=== Bundle created ==="
              ls -la "${BUNDLE_DIR##*/}."*
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-linux-glibc-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # LINUX BUILDS (MUSL)
  # Alpine-based builds for musl libc systems (e.g., Alpine Docker containers)
  # Uses QEMU for arm64 cross-compilation
  # ============================================================================
  linux-musl:
    name: Linux musl ${{ matrix.arch }}
    runs-on: ubuntu-24.04
    needs: version
    if: github.event.inputs.platform_linux_musl != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Set up QEMU (for arm64)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build in Alpine container
        run: |
          docker run --rm \
            --platform linux/${{ matrix.arch }} \
            -v ${{ github.workspace }}:/workspace \
            -e VERSION="${{ needs.version.outputs.version }}" \
            -e ARCH="${{ matrix.arch }}" \
            alpine:3.19 \
            /bin/sh -c '
              set -ex

              # Install build essentials (xz for .tar.xz extraction)
              apk add --no-cache \
                build-base autoconf automake libtool pkgconf git curl wget cmake nasm perl xz

              export WORK=/opt/deps
              export SRC=/tmp/src
              mkdir -p $WORK $SRC

              # ============================================================
              # Build all dependencies from source as static libraries
              # Based on ImageMagick official oss-fuzz approach
              # ============================================================

              # Build zlib
              cd $SRC
              wget -qO- https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz | tar xz
              cd zlib-1.3.1
              CFLAGS="-fPIC" ./configure --prefix=$WORK --static
              make -j$(nproc)
              make install

              # Build libdeflate
              cd $SRC
              wget -qO- https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.19.tar.gz | tar xz
              cd libdeflate-1.19
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DLIBDEFLATE_BUILD_SHARED_LIB=false -DLIBDEFLATE_BUILD_GZIP=false
              make -j$(nproc)
              make install

              # Build xz/lzma
              cd $SRC
              wget -qO- https://github.com/tukaani-project/xz/releases/download/v5.4.5/xz-5.4.5.tar.gz | tar xz
              cd xz-5.4.5
              ./configure --prefix=$WORK --disable-shared --enable-static --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc --with-pic
              make -j$(nproc)
              make install

              # Build zstd
              cd $SRC
              wget -qO- https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz | tar xz
              cd zstd-1.5.5
              CFLAGS="-fPIC" make -j$(nproc) lib-release
              make install PREFIX=$WORK

              # Build libpng
              cd $SRC
              wget -qO- https://github.com/pnggroup/libpng/archive/refs/tags/v1.6.43.tar.gz | tar xz
              cd libpng-1.6.43
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DPNG_SHARED=false -DPNG_STATIC=true -DCMAKE_C_FLAGS="-fPIC" -DZLIB_INCLUDE_DIR=$WORK/include -DZLIB_LIBRARY=$WORK/lib/libz.a
              make -j$(nproc)
              make install

              # Build libjpeg-turbo
              cd $SRC
              wget -qO- https://github.com/libjpeg-turbo/libjpeg-turbo/releases/download/3.0.1/libjpeg-turbo-3.0.1.tar.gz | tar xz
              cd libjpeg-turbo-3.0.1
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_STATIC=true -DENABLE_SHARED=false -DCMAKE_C_FLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build libtiff
              cd $SRC
              wget -qO- https://download.osgeo.org/libtiff/tiff-4.6.0.tar.gz | tar xz
              cd tiff-4.6.0
              ./configure --prefix=$WORK --disable-shared --enable-static CFLAGS="-fPIC -I$WORK/include" LDFLAGS="-L$WORK/lib" CPPFLAGS="-I$WORK/include"
              make -j$(nproc)
              make install

              # Build libwebp (use release tarball that includes configure)
              cd $SRC
              wget -qO- https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2.tar.gz | tar xz
              cd libwebp-1.3.2
              ./configure --prefix=$WORK --disable-shared --enable-static --disable-png --disable-jpeg --disable-tiff CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build openjpeg
              cd $SRC
              wget -qO- https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz | tar xz
              cd openjpeg-2.5.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=false -DBUILD_CODEC=false -DCMAKE_C_FLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build lcms2
              cd $SRC
              wget -qO- https://github.com/mm2/Little-CMS/releases/download/lcms2.16/lcms2-2.16.tar.gz | tar xz
              cd lcms2-2.16
              ./configure --prefix=$WORK --disable-shared --enable-static CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # Build libxml2 (use GNOME download with configure script)
              cd $SRC
              wget -qO- https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.3.tar.xz | tar xJ
              cd libxml2-2.12.3
              ./configure --prefix=$WORK --disable-shared --enable-static --without-python --without-icu CFLAGS="-fPIC"
              make -j$(nproc)
              make install

              # ============================================================
              # Build ImageMagick with all static dependencies
              # ============================================================
              cd /workspace
              git clone --depth 1 -b main https://github.com/ImageMagick/ImageMagick.git
              cd ImageMagick

              autoreconf -fiv

              export PKG_CONFIG_PATH="$WORK/lib/pkgconfig:$WORK/lib64/pkgconfig"

              ./configure \
                --prefix=/opt/imagemagick \
                --disable-shared \
                --enable-static \
                --disable-docs \
                --with-quantum-depth=16 \
                --enable-hdri \
                --without-perl \
                --without-magick-plus-plus \
                --with-png \
                --with-jpeg \
                --with-webp \
                --with-tiff \
                --with-openjp2 \
                --with-lcms \
                --with-xml \
                --with-zlib \
                --with-zstd \
                --with-lzma \
                --without-heic \
                --without-gslib \
                --without-x \
                --without-fontconfig \
                --without-freetype \
                --without-djvu \
                --without-fftw \
                --without-fpx \
                --without-dps \
                --without-jbig \
                --without-lqr \
                --without-openexr \
                --without-pango \
                --without-rsvg \
                --without-wmf \
                --without-raw \
                --without-jxl \
                CFLAGS="-fPIC -I$WORK/include" \
                CPPFLAGS="-I$WORK/include" \
                LDFLAGS="-static -L$WORK/lib -L$WORK/lib64" \
                PKG_CONFIG_PATH="$PKG_CONFIG_PATH"

              make -j$(nproc)
              make install

              # Verify the binary works and is static
              echo "=== ImageMagick Version ==="
              /opt/imagemagick/bin/magick -version

              echo "=== Checking dynamic library dependencies ==="
              ldd /opt/imagemagick/bin/magick 2>&1 || echo "(Static binary)"

              # Smoke test: verify required formats
              echo "=== Format Support Check ==="
              for fmt in PNG JPEG WEBP TIFF JP2; do
                if /opt/imagemagick/bin/magick -list format | grep -qi "^[[:space:]]*$fmt"; then
                  echo "✓ $fmt support verified"
                else
                  echo "✗ WARNING: $fmt support not found"
                fi
              done
              
              # Create minimal bundle
              BUNDLE_DIR="/workspace/imagemagick-${VERSION}-linux-musl-${ARCH}"
              mkdir -p "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib" "$BUNDLE_DIR/etc/ImageMagick-7" "$BUNDLE_DIR/share/ImageMagick-7"
              
              # Copy binary
              cp /opt/imagemagick/bin/magick "$BUNDLE_DIR/bin/"
              
              # Copy required libraries
              cp -r /opt/imagemagick/lib/ImageMagick-* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Copy config files
              cp -r /opt/imagemagick/etc/ImageMagick-7/* "$BUNDLE_DIR/etc/ImageMagick-7/" 2>/dev/null || true
              cp -r /opt/imagemagick/share/ImageMagick-7/* "$BUNDLE_DIR/share/ImageMagick-7/" 2>/dev/null || true
              
              # Add license
              cp /workspace/ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"
              
              # Create tarball
              cd /workspace
              tar -czvf "${BUNDLE_DIR##*/}.tar.gz" "${BUNDLE_DIR##*/}"
              sha256sum "${BUNDLE_DIR##*/}.tar.gz" > "${BUNDLE_DIR##*/}.sha256"
              
              echo "=== Bundle created ==="
              ls -la "${BUNDLE_DIR##*/}."*
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-linux-musl-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # MACOS BUILDS
  # Native macOS builds with Homebrew dependencies
  # Uses dylibbundler to bundle dynamic libraries
  # ============================================================================
  macos:
    name: macOS ${{ matrix.runner == 'macos-15' && 'arm64' || 'x64' }}
    runs-on: ${{ matrix.runner }}
    needs: version
    if: github.event.inputs.platform_macos != 'false'

    strategy:
      fail-fast: true
      matrix:
        runner: [macos-15, macos-14]
        include:
          - runner: macos-15
            arch: arm64
          - runner: macos-14
            arch: x64

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install dependencies via Homebrew
        run: |
          brew update
          brew install \
            jpeg libpng webp libheif ghostscript \
            openjpeg libtiff libxml2 xz \
            autoconf automake libtool pkg-config \
            dylibbundler

      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      - name: Build ImageMagick
        working-directory: ImageMagick
        run: |
          ./configure \
            --prefix=${{ github.workspace }}/install \
            --with-quantum-depth=16 \
            --enable-hdri \
            --without-perl \
            --without-magick-plus-plus \
            --with-png \
            --with-jpeg \
            --with-webp \
            --with-heic \
            --with-openjp2 \
            --with-tiff \
            --with-gslib \
            --with-xml

          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Bundle dylibs
        run: |
          INSTALL_DIR="${{ github.workspace }}/install"

          # Create lib directory if it doesn't exist
          mkdir -p "$INSTALL_DIR/lib"

          # Use dylibbundler to bundle all dependencies
          dylibbundler -of -b \
            -x "$INSTALL_DIR/bin/magick" \
            -d "$INSTALL_DIR/lib" \
            -p @executable_path/../lib

          # Verify the binary works standalone
          echo "=== Verifying bundled binary ==="
          otool -L "$INSTALL_DIR/bin/magick"

      - name: Smoke test
        run: |
          INSTALL_DIR="${{ github.workspace }}/install"

          echo "=== Format Support Check ==="
          "$INSTALL_DIR/bin/magick" -list format | head -50

          for fmt in PNG JPEG WEBP HEIC PDF; do
            if "$INSTALL_DIR/bin/magick" -list format | grep -qi "$fmt"; then
              echo "✓ $fmt support verified"
            else
              echo "✗ WARNING: $fmt support not found"
            fi
          done

      - name: Create portable bundle
        env:
          VERSION: ${{ needs.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          BUNDLE_DIR="imagemagick-${VERSION}-macos-${ARCH}"
          mkdir -p "$BUNDLE_DIR"

          # Copy essential files
          cp -r ${{ github.workspace }}/install/bin "$BUNDLE_DIR/"
          cp -r ${{ github.workspace }}/install/lib "$BUNDLE_DIR/"
          cp -r ${{ github.workspace }}/install/etc "$BUNDLE_DIR/" 2>/dev/null || true
          mkdir -p "$BUNDLE_DIR/share"
          cp -r ${{ github.workspace }}/install/share/ImageMagick-7 "$BUNDLE_DIR/share/" 2>/dev/null || true

          # Add license
          cp ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"

          # Create tarball
          tar -czvf "${BUNDLE_DIR}.tar.gz" "$BUNDLE_DIR"
          shasum -a 256 "${BUNDLE_DIR}.tar.gz" > "${BUNDLE_DIR}.sha256"

          echo "=== Bundle created ==="
          ls -la "${BUNDLE_DIR}."*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-macos-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # RELEASE PUBLISHING
  # Creates/updates a rolling prerelease with all artifacts
  # ============================================================================
  release:
    name: Publish Release
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request'
    needs:
      - version
      - windows
      - linux-glibc
      - linux-musl
      - macos

    permissions:
      contents: write

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.tar.gz" -o -name "*.sha256" | sort
          ls -la artifacts/

      - name: Create/Update rolling release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.version.outputs.version }}
          IM_COMMIT: ${{ needs.version.outputs.commit }}
          WRAPPER_COMMIT: ${{ github.sha }}
          PLATFORM_WINDOWS: ${{ github.event.inputs.platform_windows != 'false' && 'true' || 'false' }}
          PLATFORM_LINUX_GLIBC: ${{ github.event.inputs.platform_linux_glibc != 'false' && 'true' || 'false' }}
          PLATFORM_LINUX_MUSL: ${{ github.event.inputs.platform_linux_musl != 'false' && 'true' || 'false' }}
          PLATFORM_MACOS: ${{ github.event.inputs.platform_macos != 'false' && 'true' || 'false' }}
        run: |
          # Determine which platform files to replace
          PLATFORMS_TO_UPDATE=""
          [ "$PLATFORM_WINDOWS" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE windows"
          [ "$PLATFORM_LINUX_GLIBC" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE linux-glibc"
          [ "$PLATFORM_LINUX_MUSL" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE linux-musl"
          [ "$PLATFORM_MACOS" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE macos"

          echo "Platforms to update: $PLATFORMS_TO_UPDATE"

          # Check if release exists
          if gh release view bin-main &>/dev/null; then
            echo "Release exists. Updating platform-specific assets..."

            # Download existing assets to preserve them
            mkdir -p existing_assets
            gh release download bin-main --dir existing_assets --pattern "*.tar.gz" --pattern "*.sha256" 2>/dev/null || true

            # Delete only the assets for platforms being rebuilt
            for platform in $PLATFORMS_TO_UPDATE; do
              echo "Removing old $platform assets..."
              gh release delete-asset bin-main --pattern "*-${platform}-*" --yes 2>/dev/null || true
            done

            # Upload new artifacts
            echo "Uploading new artifacts..."
            gh release upload bin-main artifacts/*.tar.gz artifacts/*.sha256 --clobber

            # Update release notes
            cat > release_notes.md << EOF
          # ImageMagick Portable Binaries

          **ImageMagick Version:** ${VERSION}
          **ImageMagick Commit:** [${IM_COMMIT}](https://github.com/ImageMagick/ImageMagick/commit/${IM_COMMIT})
          **Wrapper Repo Commit:** [${WRAPPER_COMMIT:0:7}](https://github.com/${{ github.repository }}/commit/${WRAPPER_COMMIT})
          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Included Platforms

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | \`imagemagick-${VERSION}-windows-x64.tar.gz\` |
          | Windows | x86 | \`imagemagick-${VERSION}-windows-x86.tar.gz\` |
          | Linux (glibc) | amd64 | \`imagemagick-${VERSION}-linux-glibc-amd64.tar.gz\` |
          | Linux (glibc) | arm64 | \`imagemagick-${VERSION}-linux-glibc-arm64.tar.gz\` |
          | Linux (musl) | amd64 | \`imagemagick-${VERSION}-linux-musl-amd64.tar.gz\` |
          | Linux (musl) | arm64 | \`imagemagick-${VERSION}-linux-musl-arm64.tar.gz\` |
          | macOS | arm64 | \`imagemagick-${VERSION}-macos-arm64.tar.gz\` |
          | macOS | x64 | \`imagemagick-${VERSION}-macos-x64.tar.gz\` |

          ## Supported Formats
          PNG, JPEG, WEBP, HEIF/HEIC, PDF, TIFF, OpenJPEG (JP2)

          ## Notes
          - Built with Q16-HDRI quantum depth
          - Static builds for maximum portability
          - Minimal bundle size optimized for Node.js binary wrapper use
          - Updated platforms: $PLATFORMS_TO_UPDATE
          EOF

            gh release edit bin-main --notes-file release_notes.md

          else
            echo "Release does not exist. Creating new release..."

            # Create release notes
            cat > release_notes.md << EOF
          # ImageMagick Portable Binaries

          **ImageMagick Version:** ${VERSION}
          **ImageMagick Commit:** [${IM_COMMIT}](https://github.com/ImageMagick/ImageMagick/commit/${IM_COMMIT})
          **Wrapper Repo Commit:** [${WRAPPER_COMMIT:0:7}](https://github.com/${{ github.repository }}/commit/${WRAPPER_COMMIT})
          **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Included Platforms

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | \`imagemagick-${VERSION}-windows-x64.tar.gz\` |
          | Windows | x86 | \`imagemagick-${VERSION}-windows-x86.tar.gz\` |
          | Linux (glibc) | amd64 | \`imagemagick-${VERSION}-linux-glibc-amd64.tar.gz\` |
          | Linux (glibc) | arm64 | \`imagemagick-${VERSION}-linux-glibc-arm64.tar.gz\` |
          | Linux (musl) | amd64 | \`imagemagick-${VERSION}-linux-musl-amd64.tar.gz\` |
          | Linux (musl) | arm64 | \`imagemagick-${VERSION}-linux-musl-arm64.tar.gz\` |
          | macOS | arm64 | \`imagemagick-${VERSION}-macos-arm64.tar.gz\` |
          | macOS | x64 | \`imagemagick-${VERSION}-macos-x64.tar.gz\` |

          ## Supported Formats
          PNG, JPEG, WEBP, HEIF/HEIC, PDF, TIFF, OpenJPEG (JP2)

          ## Notes
          - Built with Q16-HDRI quantum depth
          - Static builds for maximum portability
          - Minimal bundle size optimized for Node.js binary wrapper use
          EOF

            # Create new prerelease
            gh release create bin-main \
              --title "ImageMagick ${VERSION} Portable Binaries" \
              --notes-file release_notes.md \
              artifacts/*.tar.gz \
              artifacts/*.sha256
          fi

  # ============================================================================
  # FAILURE HANDLER
  # Cancels the entire workflow if any job fails
  # ============================================================================
  cancel-on-failure:
    name: Cancel on Failure
    runs-on: ubuntu-24.04
    if: failure()
    needs:
      - windows
      - linux-glibc
      - linux-musl
      - macos

    steps:
      - name: Cancel workflow run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "A job failed. Cancelling workflow run..."
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
