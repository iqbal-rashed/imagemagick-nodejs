# ImageMagick Portable Binary Build Workflow
#
# This workflow builds small, portable ImageMagick binaries for use as Node.js binary wrappers.
# Based on the official ImageMagick release workflow but optimized for minimal bundle size.
#
# Key differences from official:
# - Only Q16-HDRI builds (most common for Node.js usage)
# - tar.gz instead of 7z for cross-platform compatibility
# - Minimal runtime files (no installers, no PerlMagick)
# - No code signing
# - Rolling prerelease to bin-main tag

name: Build ImageMagick Binaries

on:
  workflow_dispatch:
    inputs:
      platform_windows:
        description: "Build Windows binaries"
        type: boolean
        default: true
      platform_linux_glibc:
        description: "Build Linux glibc binaries"
        type: boolean
        default: true
      platform_linux_musl:
        description: "Build Linux musl binaries"
        type: boolean
        default: true
      platform_macos:
        description: "Build macOS binaries"
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGEMAGICK_REPO: https://github.com/ImageMagick/ImageMagick.git
  IMAGEMAGICK_BRANCH: main

jobs:
  # ============================================================================
  # VERSION EXTRACTION
  # Similar to official workflow - extracts version from ImageMagick source
  # ============================================================================
  version:
    name: Get ImageMagick Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}

    steps:
      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      - name: Extract version
        id: version
        run: |
          cd ImageMagick
          version=$(grep -oP "PACKAGE_VERSION='\K[0-9\.-]*" configure | head -1)
          commit=$(git rev-parse --short HEAD)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "commit=$commit" >> $GITHUB_OUTPUT
          echo "ImageMagick version: $version (commit: $commit)"

  # ============================================================================
  # WINDOWS BUILDS
  # Uses official ImageMagick Windows build scripts from their repo
  # Only x64 and x86 architectures (no arm64)
  # ============================================================================
  windows:
    name: Windows ${{ matrix.arch }}
    runs-on: windows-2025
    needs: version
    if: github.event.inputs.platform_windows != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [x64, x86]

    steps:
      - name: Clone this repo (for release context)
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      # Official build step: download configure tool
      - name: Download configure
        shell: cmd
        run: |
          ImageMagick\.github\build\windows\download-configure.cmd

      # Official build step: download dependencies
      # Uses static build with linked runtime for portability
      - name: Download dependencies
        shell: cmd
        run: |
          ImageMagick\.github\build\windows\download-dependencies.cmd windows-${{ matrix.arch }}-static-openMP-linked-runtime.zip

      # Official build step: run configure
      # Enable all necessary image format delegates:
      # /png - PNG support (libpng)
      # /jpeg - JPEG support (libjpeg-turbo)
      # /webp - WebP support
      # /heic - HEIF/HEIC support
      # /openjp2 - JPEG2000 support (OpenJPEG)
      # /tiff - TIFF support
      # /xml - XML support (for SVG, etc.)
      # /gs - Ghostscript support (for PDF, PS, EPS)
      - name: Configure ImageMagick
        shell: cmd
        working-directory: Configure
        run: |
          Configure.Release.x64.exe /noWizard /VS2022 /hdri /Q16 /${{ matrix.arch }} /static /linkRuntime /png /jpeg /webp /heic /openjp2 /tiff /xml /gs

      # Official build step: build with msbuild
      - name: Build ImageMagick
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
          msbuild /m /t:Rebuild /p:Configuration=Release,Platform=${{ matrix.arch }}

      # Verify format support after build
      - name: Verify format support
        shell: pwsh
        run: |
          echo "=== ImageMagick Version ==="
          & "Artifacts\bin\magick.exe" -version | Select-Object -First 10

          echo "`n=== Delegates (Format Support) ==="
          & "Artifacts\bin\magick.exe" -version | Select-String -Pattern "Delegates"

          echo "`n=== Supported Formats ==="
          & "Artifacts\bin\magick.exe" -list format | Select-String -Pattern "PNG|JPEG|JPG|WEBP|HEIC|PDF|TIFF|JP2"

          # Fail if PNG is not supported
          $delegates = & "Artifacts\bin\magick.exe" -version | Select-String -Pattern "Delegates" | Out-String
          if ($delegates -notmatch "png") {
            Write-Error "PNG support not found! Build may be incomplete."
            exit 1
          }
          echo "`n✓ PNG support verified"

      # Package minimal portable bundle (differs from official - smaller bundle)
      - name: Create portable bundle
        shell: pwsh
        env:
          VERSION: ${{ needs.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          $bundleDir = "imagemagick-$env:VERSION-windows-$env:ARCH"
          New-Item -Name $bundleDir -ItemType directory
          New-Item -Name "$bundleDir\bin" -ItemType directory

          # Core executable
          Copy-Item "Artifacts\bin\magick.exe" "$bundleDir\bin"

          # Required config files
          Copy-Item "Artifacts\bin\*.xml" "$bundleDir\bin"
          Copy-Item "Artifacts\bin\sRGB.icc" "$bundleDir\bin"

          # License
          Copy-Item "Artifacts\NOTICE.txt" $bundleDir -ErrorAction SilentlyContinue
          Copy-Item "ImageMagick\LICENSE" "$bundleDir\LICENSE.txt" -ErrorAction SilentlyContinue

          # Verify build
          & "$bundleDir\bin\magick.exe" -version

          # Create tarball
          tar -czvf "$bundleDir.tar.gz" $bundleDir

          # Generate SHA256
          $hash = (Get-FileHash -Algorithm SHA256 "$bundleDir.tar.gz").Hash.ToLower()
          "$hash  $bundleDir.tar.gz" | Out-File -Encoding ASCII "$bundleDir.sha256"

          echo "Created: $bundleDir.tar.gz"
          Get-ChildItem "$bundleDir.*"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-windows-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # LINUX BUILDS (GLIBC)
  # Ubuntu-based builds for standard glibc systems
  # Uses shared libraries bundled in tarball (like official AppImage)
  # Uses native arm64 runners for arm64 builds (free for public repos)
  # ============================================================================
  linux-glibc:
    name: Linux glibc ${{ matrix.arch }}
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    needs: version
    if: github.event.inputs.platform_linux_glibc != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build in container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -e VERSION="${{ needs.version.outputs.version }}" \
            -e ARCH="${{ matrix.arch }}" \
            ubuntu:22.04 \
            /bin/bash -c '
              set -ex

              export DEBIAN_FRONTEND=noninteractive
              apt-get update -y

              # Install build essentials (following official oss-fuzz approach)
              apt-get install -y \
                autoconf automake autopoint binutils cmake gettext git gperf g++ \
                libtool locales make nasm pkg-config curl ca-certificates patchelf

              export WORK=/opt/deps
              export SRC=/tmp/src
              mkdir -p $WORK $SRC $WORK/lib $WORK/include

              # ============================================================
              # Build all dependencies as SHARED libraries
              # Matching official ImageMagick AppImage build
              # ============================================================

              # Build zlib (shared)
              cd $SRC
              curl -sL https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz | tar xz
              cd zlib-1.3.1
              ./configure --prefix=$WORK
              make -j$(nproc)
              make install

              # Build bzip2 (shared) - required by ImageMagick
              cd $SRC
              curl -sL https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz | tar xz
              cd bzip2-1.0.8
              make -j$(nproc) -f Makefile-libbz2_so
              cp -P libbz2.so* $WORK/lib/
              cp bzlib.h $WORK/include/
              make install PREFIX=$WORK

              # Build libdeflate (shared)
              cd $SRC
              curl -sL https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.19.tar.gz | tar xz
              cd libdeflate-1.19
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DLIBDEFLATE_BUILD_SHARED_LIB=ON -DLIBDEFLATE_BUILD_GZIP=OFF
              make -j$(nproc)
              make install

              # Build xz/lzma (shared)
              cd $SRC
              curl -sL https://github.com/tukaani-project/xz/releases/download/v5.4.5/xz-5.4.5.tar.gz | tar xz
              cd xz-5.4.5
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc
              make -j$(nproc)
              make install

              # Build zstd (shared)
              cd $SRC
              curl -sL https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz | tar xz
              cd zstd-1.5.5
              make -j$(nproc)
              make install PREFIX=$WORK

              # Build libpng (shared)
              cd $SRC
              curl -sL https://github.com/pnggroup/libpng/archive/refs/tags/v1.6.43.tar.gz | tar xz
              cd libpng-1.6.43
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DPNG_SHARED=ON -DPNG_STATIC=OFF -DZLIB_INCLUDE_DIR=$WORK/include -DZLIB_LIBRARY=$WORK/lib/libz.so
              make -j$(nproc)
              make install

              # Build libjpeg-turbo (shared)
              cd $SRC
              curl -sL https://github.com/libjpeg-turbo/libjpeg-turbo/releases/download/3.0.1/libjpeg-turbo-3.0.1.tar.gz | tar xz
              cd libjpeg-turbo-3.0.1
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_SHARED=ON -DENABLE_STATIC=OFF
              make -j$(nproc)
              make install

              # Build jbigkit (shared) - for JBIG support in TIFF
              cd $SRC
              curl -sL https://www.cl.cam.ac.uk/~mgk25/jbigkit/download/jbigkit-2.1.tar.gz | tar xz
              cd jbigkit-2.1
              make -j$(nproc) lib
              cp libjbig/*.h $WORK/include/
              cp libjbig/libjbig.a $WORK/lib/
              # Build shared library
              cd libjbig
              gcc -shared -o libjbig.so.2.1 -Wl,-soname,libjbig.so.2 jbig.o jbig_ar.o
              cp libjbig.so.2.1 $WORK/lib/
              ln -sf libjbig.so.2.1 $WORK/lib/libjbig.so.2
              ln -sf libjbig.so.2 $WORK/lib/libjbig.so

              # Build libtiff (shared) - with JBIG support
              cd $SRC
              curl -sL https://download.osgeo.org/libtiff/tiff-4.6.0.tar.gz | tar xz
              cd tiff-4.6.0
              ./configure --prefix=$WORK --enable-shared --disable-static --with-jbig-include-dir=$WORK/include --with-jbig-lib-dir=$WORK/lib CFLAGS="-I$WORK/include" LDFLAGS="-L$WORK/lib" CPPFLAGS="-I$WORK/include"
              make -j$(nproc)
              make install

              # Build libwebp (shared)
              cd $SRC
              curl -sL https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2.tar.gz | tar xz
              cd libwebp-1.3.2
              ./configure --prefix=$WORK --enable-shared --disable-static --enable-libwebpmux --enable-libwebpdemux
              make -j$(nproc)
              make install

              # Build openjpeg (shared)
              cd $SRC
              curl -sL https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz | tar xz
              cd openjpeg-2.5.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON -DBUILD_CODEC=OFF
              make -j$(nproc)
              make install

              # Build lcms2 (shared)
              cd $SRC
              curl -sL https://github.com/mm2/Little-CMS/releases/download/lcms2.16/lcms2-2.16.tar.gz | tar xz
              cd lcms2-2.16
              ./configure --prefix=$WORK --enable-shared --disable-static
              make -j$(nproc)
              make install

              # Build libxml2 (shared)
              cd $SRC
              curl -sL https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.3.tar.xz | tar xJ
              cd libxml2-2.12.3
              ./configure --prefix=$WORK --enable-shared --disable-static --without-python --without-icu
              make -j$(nproc)
              make install

              # Build brotli (required for JPEG-XL)
              cd $SRC
              curl -sL https://github.com/google/brotli/archive/refs/tags/v1.1.0.tar.gz | tar xz
              cd brotli-1.1.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON
              make -j$(nproc)
              make install

              # Build highway (required for JPEG-XL)
              cd $SRC
              curl -sL https://github.com/google/highway/archive/refs/tags/1.0.7.tar.gz | tar xz
              cd highway-1.0.7
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON -DHWY_ENABLE_TESTS=OFF -DHWY_ENABLE_EXAMPLES=OFF
              make -j$(nproc)
              make install

              # Build libjxl (JPEG-XL support) - clone with submodules for skcms
              cd $SRC
              git clone --depth 1 --branch v0.10.2 --recursive https://github.com/libjxl/libjxl.git
              cd libjxl
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK \
                -DBUILD_SHARED_LIBS=ON \
                -DBUILD_TESTING=OFF \
                -DJPEGXL_ENABLE_TOOLS=OFF \
                -DJPEGXL_ENABLE_DOXYGEN=OFF \
                -DJPEGXL_ENABLE_MANPAGES=OFF \
                -DJPEGXL_ENABLE_BENCHMARK=OFF \
                -DJPEGXL_ENABLE_EXAMPLES=OFF \
                -DJPEGXL_ENABLE_JNI=OFF \
                -DJPEGXL_ENABLE_SJPEG=OFF \
                -DJPEGXL_ENABLE_OPENEXR=OFF \
                -DJPEGXL_BUNDLE_LIBPNG=OFF \
                -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
                -DJPEGXL_FORCE_SYSTEM_HWY=ON \
                -DCMAKE_PREFIX_PATH=$WORK
              make -j$(nproc)
              make install

              # Build libde265 (required for HEIC)
              cd $SRC
              curl -sL https://github.com/strukturag/libde265/releases/download/v1.0.15/libde265-1.0.15.tar.gz | tar xz
              cd libde265-1.0.15
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-dec265 --disable-sherlock265
              make -j$(nproc)
              make install

              # Build x265 (for HEIC encoding)
              cd $SRC
              curl -sL https://github.com/videolan/x265/archive/refs/tags/3.6.tar.gz | tar xz
              cd x265-3.6/build/linux
              cmake ../../source -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_SHARED=ON -DENABLE_CLI=OFF
              make -j$(nproc)
              make install

              # Build libheif (HEIC/HEIF support)
              cd $SRC
              curl -sL https://github.com/strukturag/libheif/releases/download/v1.17.6/libheif-1.17.6.tar.gz | tar xz
              cd libheif-1.17.6
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK \
                -DBUILD_SHARED_LIBS=ON \
                -DWITH_LIBDE265=ON \
                -DWITH_X265=ON \
                -DWITH_EXAMPLES=OFF \
                -DCMAKE_PREFIX_PATH=$WORK
              make -j$(nproc)
              make install

              # Build freetype (for text/fonts)
              cd $SRC
              curl -sL https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz | tar xz
              cd freetype-2.13.2
              ./configure --prefix=$WORK --enable-shared --disable-static --with-zlib=$WORK --with-png=$WORK --with-bzip2=$WORK
              make -j$(nproc)
              make install

              # Build LibRaw (for RAW camera formats)
              cd $SRC
              curl -sL https://www.libraw.org/data/LibRaw-0.21.2.tar.gz | tar xz
              cd LibRaw-0.21.2
              autoreconf -fiv
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-examples
              make -j$(nproc)
              make install

              # ============================================================
              # Build ImageMagick with shared libraries
              # Matching official ImageMagick AppImage configuration
              # ============================================================
              cd /workspace
              git clone --depth 1 -b main https://github.com/ImageMagick/ImageMagick.git
              cd ImageMagick

              autoreconf -fiv

              export PKG_CONFIG_PATH="$WORK/lib/pkgconfig:$WORK/lib64/pkgconfig"
              export LD_LIBRARY_PATH="$WORK/lib:$WORK/lib64"
              export LDFLAGS="-L$WORK/lib -L$WORK/lib64 -Wl,-rpath,\\\$ORIGIN/../lib"

              ./configure \
                --prefix=/opt/imagemagick \
                --enable-shared \
                --disable-static \
                --disable-docs \
                --enable-openmp \
                --with-quantum-depth=16 \
                --enable-hdri \
                --without-perl \
                --without-magick-plus-plus \
                --with-bzlib \
                --with-png \
                --with-jpeg \
                --with-webp \
                --with-tiff \
                --with-openjp2 \
                --with-lcms \
                --with-xml \
                --with-zlib \
                --with-zstd \
                --with-lzma \
                --with-heic \
                --with-jxl \
                --with-freetype \
                --with-jbig \
                --with-raw \
                --without-gslib \
                --without-x \
                --without-fontconfig \
                --without-djvu \
                --without-fftw \
                --without-fpx \
                --without-dps \
                --without-lqr \
                --without-openexr \
                --without-pango \
                --without-rsvg \
                --without-wmf \
                CFLAGS="-I$WORK/include" \
                CPPFLAGS="-I$WORK/include" \
                LDFLAGS="$LDFLAGS" \
                PKG_CONFIG_PATH="$PKG_CONFIG_PATH"

              make -j$(nproc)
              make install

              # Verify the binary works
              echo "=== ImageMagick Version ==="
              LD_LIBRARY_PATH="/opt/imagemagick/lib:$WORK/lib:$WORK/lib64" /opt/imagemagick/bin/magick -version

              # Check dynamic dependencies
              echo "=== Checking dynamic library dependencies ==="
              ldd /opt/imagemagick/bin/magick

              # Format support check (matching official AppImage)
              echo "=== Format Support Check ==="
              for fmt in PNG JPEG WEBP TIFF JP2 HEIC JXL RAW DNG CR2; do
                if LD_LIBRARY_PATH="/opt/imagemagick/lib:$WORK/lib:$WORK/lib64" /opt/imagemagick/bin/magick -list format | grep -qi "^[[:space:]]*$fmt"; then
                  echo "✓ $fmt support verified"
                else
                  echo "✗ WARNING: $fmt support not found"
                fi
              done
              
              # ============================================================
              # Create portable bundle with all shared libraries
              # ============================================================
              BUNDLE_DIR="/workspace/imagemagick-${VERSION}-linux-glibc-${ARCH}"
              mkdir -p "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib" "$BUNDLE_DIR/etc/ImageMagick-7" "$BUNDLE_DIR/share/ImageMagick-7"
              
              # Copy the magick binary
              cp /opt/imagemagick/bin/magick "$BUNDLE_DIR/bin/magick.bin"
              
              # Copy ImageMagick libraries
              cp -P /opt/imagemagick/lib/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              cp -rP /opt/imagemagick/lib/ImageMagick-* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Copy all dependency shared libraries
              cp -P $WORK/lib/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              cp -P $WORK/lib64/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Use ldd to find any missing system libraries and copy them
              echo "=== Copying required system libraries ==="
              for lib in $(ldd /opt/imagemagick/bin/magick | grep "=> /" | awk "{print \$3}"); do
                libname=$(basename "$lib")
                # Skip standard glibc libraries that should always be present
                case "$libname" in
                  libc.so*|libm.so*|libpthread.so*|libdl.so*|librt.so*|ld-linux*) 
                    echo "Skipping system lib: $libname"
                    ;;
                  *)
                    if [ ! -f "$BUNDLE_DIR/lib/$libname" ]; then
                      echo "Copying: $lib"
                      cp -P "$lib" "$BUNDLE_DIR/lib/" 2>/dev/null || true
                      # Also copy any symlink targets
                      if [ -L "$lib" ]; then
                        cp -P "$(readlink -f "$lib")" "$BUNDLE_DIR/lib/" 2>/dev/null || true
                      fi
                    fi
                    ;;
                esac
              done

              # Copy config files
              cp -r /opt/imagemagick/etc/ImageMagick-7/* "$BUNDLE_DIR/etc/ImageMagick-7/" 2>/dev/null || true
              cp -r /opt/imagemagick/share/ImageMagick-7/* "$BUNDLE_DIR/share/ImageMagick-7/" 2>/dev/null || true
              
              # Add license
              cp /workspace/ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"
              
              # ============================================================
              # Bundle minimal font for text operations (~200KB)
              # ============================================================
              echo "=== Bundling font ==="
              mkdir -p "$BUNDLE_DIR/share/fonts"
              cd $SRC
              
              # Download DejaVu Sans (minimal, permissive license)
              curl -sL https://github.com/dejavu-fonts/dejavu-fonts/releases/download/version_2_37/dejavu-fonts-ttf-2.37.tar.bz2 | tar xj
              cp dejavu-fonts-ttf-2.37/ttf/DejaVuSans.ttf "$BUNDLE_DIR/share/fonts/"
              
              # Create type.xml to register the font as default (using echo to avoid heredoc)
              echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "<typemap>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"DejaVu-Sans\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"sans-serif\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"Arial\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "</typemap>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              
              echo "Font bundled: $(ls -lh $BUNDLE_DIR/share/fonts/)"
              
              # ============================================================
              # Strip debug symbols to reduce size (like official AppImage)
              # ============================================================
              echo "=== Stripping debug symbols ==="
              echo "Size before stripping:"
              du -sh "$BUNDLE_DIR/lib" "$BUNDLE_DIR/bin"
              
              # Strip the binary
              strip --strip-all "$BUNDLE_DIR/bin/magick.bin" 2>/dev/null || true
              
              # Strip all shared libraries
              find "$BUNDLE_DIR/lib" -name "*.so*" -type f -exec strip --strip-unneeded {} \; 2>/dev/null || true
              
              # Remove static libraries and other unnecessary files
              find "$BUNDLE_DIR" -name "*.a" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "*.la" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "pkgconfig" -type d -exec rm -rf {} + 2>/dev/null || true
              find "$BUNDLE_DIR" -name "cmake" -type d -exec rm -rf {} + 2>/dev/null || true
              find "$BUNDLE_DIR" -name "*.h" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "include" -type d -exec rm -rf {} + 2>/dev/null || true
              
              echo "Size after stripping:"
              du -sh "$BUNDLE_DIR/lib" "$BUNDLE_DIR/bin"
              
              # Create wrapper script that sets LD_LIBRARY_PATH (using echo to avoid heredoc issues)
              echo "#!/bin/sh" > "$BUNDLE_DIR/bin/magick"
              echo "SCRIPT_DIR=\"\$(cd \"\$(dirname \"\$0\")\" && pwd)\"" >> "$BUNDLE_DIR/bin/magick"
              echo "BUNDLE_DIR=\"\$(cd \"\$SCRIPT_DIR/..\" && pwd)\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export LD_LIBRARY_PATH=\"\$BUNDLE_DIR/lib:\$LD_LIBRARY_PATH\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export MAGICK_HOME=\"\$BUNDLE_DIR\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export MAGICK_CONFIGURE_PATH=\"\$BUNDLE_DIR/etc/ImageMagick-7\"" >> "$BUNDLE_DIR/bin/magick"
              echo "exec \"\$SCRIPT_DIR/magick.bin\" \"\$@\"" >> "$BUNDLE_DIR/bin/magick"
              chmod +x "$BUNDLE_DIR/bin/magick"
              
              # Test the bundle
              echo "=== Testing bundle ==="
              "$BUNDLE_DIR/bin/magick" -version
              
              # Show bundle size
              echo "=== Bundle contents ==="
              du -sh "$BUNDLE_DIR"
              du -sh "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib"
              ls -la "$BUNDLE_DIR/lib/" | head -30
              
              # Create tarball
              cd /workspace
              tar -czvf "${BUNDLE_DIR##*/}.tar.gz" "${BUNDLE_DIR##*/}"
              sha256sum "${BUNDLE_DIR##*/}.tar.gz" > "${BUNDLE_DIR##*/}.sha256"
              
              echo "=== Bundle created ==="
              ls -la "${BUNDLE_DIR##*/}."*
            '

      - name: Verify artifacts exist
        run: |
          echo "=== Workspace contents ==="
          ls -la
          echo "=== Looking for tarballs ==="
          ls -la imagemagick-*.tar.gz imagemagick-*.sha256 || echo "No artifacts found!"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-linux-glibc-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # LINUX BUILDS (MUSL)
  # Alpine-based builds for musl libc systems (e.g., Alpine Docker containers)
  # Uses shared libraries bundled in tarball (like official AppImage)
  # Uses native arm64 runners for arm64 builds (free for public repos)
  # ============================================================================
  linux-musl:
    name: Linux musl ${{ matrix.arch }}
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    needs: version
    if: github.event.inputs.platform_linux_musl != 'false'

    strategy:
      fail-fast: true
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Build in Alpine container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -e VERSION="${{ needs.version.outputs.version }}" \
            -e ARCH="${{ matrix.arch }}" \
            alpine:3.19 \
            /bin/sh -c '
              set -ex

              # Install build essentials
              apk add --no-cache \
                build-base autoconf automake libtool pkgconf git curl wget cmake nasm perl xz \
                patchelf linux-headers

              export WORK=/opt/deps
              export SRC=/tmp/src
              mkdir -p $WORK $SRC $WORK/lib $WORK/include

              # ============================================================
              # Build all dependencies as SHARED libraries
              # Matching official ImageMagick AppImage build
              # ============================================================

              # Build zlib (shared)
              cd $SRC
              wget -qO- https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz | tar xz
              cd zlib-1.3.1
              ./configure --prefix=$WORK
              make -j$(nproc)
              make install

              # Build bzip2 (shared) - required by ImageMagick
              cd $SRC
              wget -qO- https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz | tar xz
              cd bzip2-1.0.8
              make -j$(nproc) -f Makefile-libbz2_so
              cp -P libbz2.so* $WORK/lib/
              cp bzlib.h $WORK/include/
              make install PREFIX=$WORK

              # Build libdeflate (shared)
              cd $SRC
              wget -qO- https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.19.tar.gz | tar xz
              cd libdeflate-1.19
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DLIBDEFLATE_BUILD_SHARED_LIB=ON -DLIBDEFLATE_BUILD_GZIP=OFF
              make -j$(nproc)
              make install

              # Build xz/lzma (shared)
              cd $SRC
              wget -qO- https://github.com/tukaani-project/xz/releases/download/v5.4.5/xz-5.4.5.tar.gz | tar xz
              cd xz-5.4.5
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-xz --disable-xzdec --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc
              make -j$(nproc)
              make install

              # Build zstd (shared)
              cd $SRC
              wget -qO- https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz | tar xz
              cd zstd-1.5.5
              make -j$(nproc)
              make install PREFIX=$WORK

              # Build libpng (shared)
              cd $SRC
              wget -qO- https://github.com/pnggroup/libpng/archive/refs/tags/v1.6.43.tar.gz | tar xz
              cd libpng-1.6.43
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DPNG_SHARED=ON -DPNG_STATIC=OFF -DZLIB_INCLUDE_DIR=$WORK/include -DZLIB_LIBRARY=$WORK/lib/libz.so
              make -j$(nproc)
              make install

              # Build libjpeg-turbo (shared)
              cd $SRC
              wget -qO- https://github.com/libjpeg-turbo/libjpeg-turbo/releases/download/3.0.1/libjpeg-turbo-3.0.1.tar.gz | tar xz
              cd libjpeg-turbo-3.0.1
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_SHARED=ON -DENABLE_STATIC=OFF
              make -j$(nproc)
              make install

              # Build jbigkit (shared) - for JBIG support in TIFF
              cd $SRC
              wget -qO- https://www.cl.cam.ac.uk/~mgk25/jbigkit/download/jbigkit-2.1.tar.gz | tar xz
              cd jbigkit-2.1
              make -j$(nproc) lib
              cp libjbig/*.h $WORK/include/
              cp libjbig/libjbig.a $WORK/lib/
              # Build shared library
              cd libjbig
              gcc -shared -o libjbig.so.2.1 -Wl,-soname,libjbig.so.2 jbig.o jbig_ar.o
              cp libjbig.so.2.1 $WORK/lib/
              ln -sf libjbig.so.2.1 $WORK/lib/libjbig.so.2
              ln -sf libjbig.so.2 $WORK/lib/libjbig.so

              # Build libtiff (shared) - with JBIG support
              cd $SRC
              wget -qO- https://download.osgeo.org/libtiff/tiff-4.6.0.tar.gz | tar xz
              cd tiff-4.6.0
              ./configure --prefix=$WORK --enable-shared --disable-static --with-jbig-include-dir=$WORK/include --with-jbig-lib-dir=$WORK/lib CFLAGS="-I$WORK/include" LDFLAGS="-L$WORK/lib" CPPFLAGS="-I$WORK/include"
              make -j$(nproc)
              make install

              # Build libwebp (shared)
              cd $SRC
              wget -qO- https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.3.2.tar.gz | tar xz
              cd libwebp-1.3.2
              ./configure --prefix=$WORK --enable-shared --disable-static --enable-libwebpmux --enable-libwebpdemux
              make -j$(nproc)
              make install

              # Build openjpeg (shared)
              cd $SRC
              wget -qO- https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz | tar xz
              cd openjpeg-2.5.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON -DBUILD_CODEC=OFF
              make -j$(nproc)
              make install

              # Build lcms2 (shared)
              cd $SRC
              wget -qO- https://github.com/mm2/Little-CMS/releases/download/lcms2.16/lcms2-2.16.tar.gz | tar xz
              cd lcms2-2.16
              ./configure --prefix=$WORK --enable-shared --disable-static
              make -j$(nproc)
              make install

              # Build libxml2 (shared)
              cd $SRC
              wget -qO- https://download.gnome.org/sources/libxml2/2.12/libxml2-2.12.3.tar.xz | tar xJ
              cd libxml2-2.12.3
              ./configure --prefix=$WORK --enable-shared --disable-static --without-python --without-icu
              make -j$(nproc)
              make install

              # Build brotli (required for JPEG-XL)
              cd $SRC
              wget -qO- https://github.com/google/brotli/archive/refs/tags/v1.1.0.tar.gz | tar xz
              cd brotli-1.1.0
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON
              make -j$(nproc)
              make install

              # Build highway (required for JPEG-XL)
              cd $SRC
              wget -qO- https://github.com/google/highway/archive/refs/tags/1.0.7.tar.gz | tar xz
              cd highway-1.0.7
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK -DBUILD_SHARED_LIBS=ON -DHWY_ENABLE_TESTS=OFF -DHWY_ENABLE_EXAMPLES=OFF
              make -j$(nproc)
              make install

              # Build libjxl (JPEG-XL support) - clone with submodules for skcms
              cd $SRC
              git clone --depth 1 --branch v0.10.2 --recursive https://github.com/libjxl/libjxl.git
              cd libjxl
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK \
                -DBUILD_SHARED_LIBS=ON \
                -DBUILD_TESTING=OFF \
                -DJPEGXL_ENABLE_TOOLS=OFF \
                -DJPEGXL_ENABLE_DOXYGEN=OFF \
                -DJPEGXL_ENABLE_MANPAGES=OFF \
                -DJPEGXL_ENABLE_BENCHMARK=OFF \
                -DJPEGXL_ENABLE_EXAMPLES=OFF \
                -DJPEGXL_ENABLE_JNI=OFF \
                -DJPEGXL_ENABLE_SJPEG=OFF \
                -DJPEGXL_ENABLE_OPENEXR=OFF \
                -DJPEGXL_BUNDLE_LIBPNG=OFF \
                -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
                -DJPEGXL_FORCE_SYSTEM_HWY=ON \
                -DCMAKE_PREFIX_PATH=$WORK
              make -j$(nproc)
              make install

              # Build libde265 (required for HEIC)
              cd $SRC
              wget -qO- https://github.com/strukturag/libde265/releases/download/v1.0.15/libde265-1.0.15.tar.gz | tar xz
              cd libde265-1.0.15
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-dec265 --disable-sherlock265
              make -j$(nproc)
              make install

              # Build x265 (for HEIC encoding)
              cd $SRC
              wget -qO- https://github.com/videolan/x265/archive/refs/tags/3.6.tar.gz | tar xz
              cd x265-3.6/build/linux
              cmake ../../source -DCMAKE_INSTALL_PREFIX=$WORK -DENABLE_SHARED=ON -DENABLE_CLI=OFF
              make -j$(nproc)
              make install

              # Build libheif (HEIC/HEIF support)
              cd $SRC
              wget -qO- https://github.com/strukturag/libheif/releases/download/v1.17.6/libheif-1.17.6.tar.gz | tar xz
              cd libheif-1.17.6
              cmake . -DCMAKE_INSTALL_PREFIX=$WORK \
                -DBUILD_SHARED_LIBS=ON \
                -DWITH_LIBDE265=ON \
                -DWITH_X265=ON \
                -DWITH_EXAMPLES=OFF \
                -DCMAKE_PREFIX_PATH=$WORK
              make -j$(nproc)
              make install

              # Build freetype (for text/fonts)
              cd $SRC
              wget -qO- https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz | tar xz
              cd freetype-2.13.2
              ./configure --prefix=$WORK --enable-shared --disable-static --with-zlib=$WORK --with-png=$WORK --with-bzip2=$WORK
              make -j$(nproc)
              make install

              # Build LibRaw (for RAW camera formats)
              cd $SRC
              wget -qO- https://www.libraw.org/data/LibRaw-0.21.2.tar.gz | tar xz
              cd LibRaw-0.21.2
              autoreconf -fiv
              ./configure --prefix=$WORK --enable-shared --disable-static --disable-examples
              make -j$(nproc)
              make install

              # ============================================================
              # Build ImageMagick with shared libraries
              # Matching official ImageMagick AppImage configuration
              # Note: OpenMP disabled for musl (not well supported)
              # ============================================================
              cd /workspace
              git clone --depth 1 -b main https://github.com/ImageMagick/ImageMagick.git
              cd ImageMagick

              autoreconf -fiv

              export PKG_CONFIG_PATH="$WORK/lib/pkgconfig:$WORK/lib64/pkgconfig"
              export LD_LIBRARY_PATH="$WORK/lib:$WORK/lib64"
              export LDFLAGS="-L$WORK/lib -L$WORK/lib64 -Wl,-rpath,\\\$ORIGIN/../lib"

              ./configure \
                --prefix=/opt/imagemagick \
                --enable-shared \
                --disable-static \
                --disable-docs \
                --disable-openmp \
                --with-quantum-depth=16 \
                --enable-hdri \
                --without-perl \
                --without-magick-plus-plus \
                --with-bzlib \
                --with-png \
                --with-jpeg \
                --with-webp \
                --with-tiff \
                --with-openjp2 \
                --with-lcms \
                --with-xml \
                --with-zlib \
                --with-zstd \
                --with-lzma \
                --with-heic \
                --with-jxl \
                --with-freetype \
                --with-jbig \
                --with-raw \
                --without-gslib \
                --without-x \
                --without-fontconfig \
                --without-djvu \
                --without-fftw \
                --without-fpx \
                --without-dps \
                --without-lqr \
                --without-openexr \
                --without-pango \
                --without-rsvg \
                --without-wmf \
                CFLAGS="-I$WORK/include" \
                CPPFLAGS="-I$WORK/include" \
                LDFLAGS="$LDFLAGS" \
                PKG_CONFIG_PATH="$PKG_CONFIG_PATH"

              make -j$(nproc)
              make install

              # Verify the binary works
              echo "=== ImageMagick Version ==="
              LD_LIBRARY_PATH="/opt/imagemagick/lib:$WORK/lib:$WORK/lib64" /opt/imagemagick/bin/magick -version

              # Check dynamic dependencies
              echo "=== Checking dynamic library dependencies ==="
              ldd /opt/imagemagick/bin/magick

              # Format support check (matching official AppImage)
              echo "=== Format Support Check ==="
              for fmt in PNG JPEG WEBP TIFF JP2 HEIC JXL RAW DNG CR2; do
                if LD_LIBRARY_PATH="/opt/imagemagick/lib:$WORK/lib:$WORK/lib64" /opt/imagemagick/bin/magick -list format | grep -qi "^[[:space:]]*$fmt"; then
                  echo "✓ $fmt support verified"
                else
                  echo "✗ WARNING: $fmt support not found"
                fi
              done
              
              # ============================================================
              # Create portable bundle with all shared libraries
              # ============================================================
              BUNDLE_DIR="/workspace/imagemagick-${VERSION}-linux-musl-${ARCH}"
              mkdir -p "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib" "$BUNDLE_DIR/etc/ImageMagick-7" "$BUNDLE_DIR/share/ImageMagick-7"
              
              # Copy the magick binary
              cp /opt/imagemagick/bin/magick "$BUNDLE_DIR/bin/magick.bin"
              
              # Copy ImageMagick libraries
              cp -P /opt/imagemagick/lib/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              cp -rP /opt/imagemagick/lib/ImageMagick-* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Copy all dependency shared libraries
              cp -P $WORK/lib/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              cp -P $WORK/lib64/*.so* "$BUNDLE_DIR/lib/" 2>/dev/null || true
              
              # Use ldd to find any missing system libraries and copy them
              echo "=== Copying required system libraries ==="
              for lib in $(ldd /opt/imagemagick/bin/magick | grep "=> /" | awk "{print \$3}"); do
                libname=$(basename "$lib")
                # Skip standard musl libraries
                case "$libname" in
                  libc.musl*|ld-musl*) 
                    echo "Skipping system lib: $libname"
                    ;;
                  *)
                    if [ ! -f "$BUNDLE_DIR/lib/$libname" ]; then
                      echo "Copying: $lib"
                      cp -P "$lib" "$BUNDLE_DIR/lib/" 2>/dev/null || true
                      # Also copy any symlink targets
                      if [ -L "$lib" ]; then
                        cp -P "$(readlink -f "$lib")" "$BUNDLE_DIR/lib/" 2>/dev/null || true
                      fi
                    fi
                    ;;
                esac
              done

              # Copy config files
              cp -r /opt/imagemagick/etc/ImageMagick-7/* "$BUNDLE_DIR/etc/ImageMagick-7/" 2>/dev/null || true
              cp -r /opt/imagemagick/share/ImageMagick-7/* "$BUNDLE_DIR/share/ImageMagick-7/" 2>/dev/null || true
              
              # Add license
              cp /workspace/ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"
              
              # ============================================================
              # Bundle minimal font for text operations (~200KB)
              # ============================================================
              echo "=== Bundling font ==="
              mkdir -p "$BUNDLE_DIR/share/fonts"
              cd $SRC
              
              # Download DejaVu Sans (minimal, permissive license)
              wget -qO- https://github.com/dejavu-fonts/dejavu-fonts/releases/download/version_2_37/dejavu-fonts-ttf-2.37.tar.bz2 | tar xj
              cp dejavu-fonts-ttf-2.37/ttf/DejaVuSans.ttf "$BUNDLE_DIR/share/fonts/"
              
              # Create type.xml to register the font as default (using echo to avoid heredoc)
              echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "<typemap>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"DejaVu-Sans\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"sans-serif\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "  <type name=\"Arial\" fullname=\"DejaVu Sans\" family=\"DejaVu Sans\" style=\"Normal\" stretch=\"Normal\" weight=\"400\" glyphs=\"fonts/DejaVuSans.ttf\"/>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              echo "</typemap>" >> "$BUNDLE_DIR/etc/ImageMagick-7/type.xml"
              
              echo "Font bundled: $(ls -lh $BUNDLE_DIR/share/fonts/)"
              
              # ============================================================
              # Strip debug symbols to reduce size (like official AppImage)
              # ============================================================
              echo "=== Stripping debug symbols ==="
              echo "Size before stripping:"
              du -sh "$BUNDLE_DIR/lib" "$BUNDLE_DIR/bin"
              
              # Strip the binary
              strip --strip-all "$BUNDLE_DIR/bin/magick.bin" 2>/dev/null || true
              
              # Strip all shared libraries
              find "$BUNDLE_DIR/lib" -name "*.so*" -type f -exec strip --strip-unneeded {} \; 2>/dev/null || true
              
              # Remove static libraries and other unnecessary files
              find "$BUNDLE_DIR" -name "*.a" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "*.la" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "pkgconfig" -type d -exec rm -rf {} + 2>/dev/null || true
              find "$BUNDLE_DIR" -name "cmake" -type d -exec rm -rf {} + 2>/dev/null || true
              find "$BUNDLE_DIR" -name "*.h" -delete 2>/dev/null || true
              find "$BUNDLE_DIR" -name "include" -type d -exec rm -rf {} + 2>/dev/null || true
              
              echo "Size after stripping:"
              du -sh "$BUNDLE_DIR/lib" "$BUNDLE_DIR/bin"
              
              # Create wrapper script that sets LD_LIBRARY_PATH (using echo to avoid heredoc issues)
              echo "#!/bin/sh" > "$BUNDLE_DIR/bin/magick"
              echo "SCRIPT_DIR=\"\$(cd \"\$(dirname \"\$0\")\" && pwd)\"" >> "$BUNDLE_DIR/bin/magick"
              echo "BUNDLE_DIR=\"\$(cd \"\$SCRIPT_DIR/..\" && pwd)\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export LD_LIBRARY_PATH=\"\$BUNDLE_DIR/lib:\$LD_LIBRARY_PATH\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export MAGICK_HOME=\"\$BUNDLE_DIR\"" >> "$BUNDLE_DIR/bin/magick"
              echo "export MAGICK_CONFIGURE_PATH=\"\$BUNDLE_DIR/etc/ImageMagick-7\"" >> "$BUNDLE_DIR/bin/magick"
              echo "exec \"\$SCRIPT_DIR/magick.bin\" \"\$@\"" >> "$BUNDLE_DIR/bin/magick"
              chmod +x "$BUNDLE_DIR/bin/magick"
              
              # Test the bundle
              echo "=== Testing bundle ==="
              "$BUNDLE_DIR/bin/magick" -version
              
              # Show bundle size
              echo "=== Bundle contents ==="
              du -sh "$BUNDLE_DIR"
              du -sh "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib"
              ls -la "$BUNDLE_DIR/lib/" | head -30
              
              # Create tarball
              cd /workspace
              tar -czvf "${BUNDLE_DIR##*/}.tar.gz" "${BUNDLE_DIR##*/}"
              sha256sum "${BUNDLE_DIR##*/}.tar.gz" > "${BUNDLE_DIR##*/}.sha256"
              
              echo "=== Bundle created ==="
              ls -la "${BUNDLE_DIR##*/}."*
            '

      - name: Verify artifacts exist
        run: |
          echo "=== Workspace contents ==="
          ls -la
          echo "=== Looking for tarballs ==="
          ls -la imagemagick-*.tar.gz imagemagick-*.sha256 || echo "No artifacts found!"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-linux-musl-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # MACOS BUILDS
  # Native macOS builds with Homebrew dependencies
  # Uses dylibbundler to bundle dynamic libraries
  # ============================================================================
  macos:
    name: macOS ${{ matrix.runner == 'macos-15' && 'arm64' || 'x64' }}
    runs-on: ${{ matrix.runner }}
    needs: version
    if: github.event.inputs.platform_macos != 'false'

    strategy:
      fail-fast: true
      matrix:
        runner: [macos-15, macos-15-intel]
        include:
          - runner: macos-15
            arch: arm64
          - runner: macos-15-intel
            arch: x64

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Install dependencies via Homebrew
        run: |
          brew update
          # Install all image format dependencies (matching Linux/official builds)
          # Note: webp (not libwebp), jpeg-turbo (not libjpeg-turbo)
          # Skip libraw - its pkg-config injects OpenMP flags that Apple clang can't handle
          brew install \
            zlib xz zstd bzip2 \
            libpng jpeg-turbo libtiff webp openjpeg \
            little-cms2 libxml2 \
            libheif libde265 x265 \
            jpeg-xl highway brotli \
            freetype ghostscript \
            autoconf automake libtool pkg-config \
            dylibbundler

      - name: Clone ImageMagick
        uses: actions/checkout@v4
        with:
          repository: ImageMagick/ImageMagick
          ref: main
          path: ImageMagick
          persist-credentials: false

      - name: Build ImageMagick
        working-directory: ImageMagick
        run: |
          # Set PKG_CONFIG_PATH for Homebrew dependencies (arm64 and x64 paths)
          if [ -d "/opt/homebrew" ]; then
            BREW_PREFIX="/opt/homebrew"
          else
            BREW_PREFIX="/usr/local"
          fi

          export PKG_CONFIG_PATH="$BREW_PREFIX/lib/pkgconfig:$BREW_PREFIX/opt/zlib/lib/pkgconfig:$BREW_PREFIX/opt/bzip2/lib/pkgconfig:$PKG_CONFIG_PATH"
          export CPPFLAGS="-I$BREW_PREFIX/include -I$BREW_PREFIX/opt/zlib/include -I$BREW_PREFIX/opt/bzip2/include"
          export LDFLAGS="-L$BREW_PREFIX/lib -L$BREW_PREFIX/opt/zlib/lib -L$BREW_PREFIX/opt/bzip2/lib"

          ./configure \
            --prefix=${{ github.workspace }}/install \
            --enable-shared \
            --disable-static \
            --disable-docs \
            --disable-openmp \
            --with-quantum-depth=16 \
            --enable-hdri \
            --without-perl \
            --without-magick-plus-plus \
            --with-bzlib \
            --with-zlib \
            --with-zstd \
            --with-lzma \
            --with-png \
            --with-jpeg \
            --with-tiff \
            --with-webp \
            --with-openjp2 \
            --with-heic \
            --with-jxl \
            --without-raw \
            --with-lcms \
            --with-xml \
            --with-freetype \
            --with-gslib \
            --without-openexr \
            --without-fontconfig \
            --without-djvu \
            --without-fftw \
            --without-fpx \
            --without-dps \
            --without-lqr \
            --without-pango \
            --without-rsvg \
            --without-wmf \
            --without-x

          make -j$(sysctl -n hw.ncpu)
          make install

      - name: Bundle dylibs
        run: |
          INSTALL_DIR="${{ github.workspace }}/install"

          # Create lib directory if it doesn't exist
          mkdir -p "$INSTALL_DIR/lib"

          # Use dylibbundler to bundle all dependencies
          # The -of flag overwrites files, -b fixes linking
          dylibbundler -of -b \
            -x "$INSTALL_DIR/bin/magick" \
            -d "$INSTALL_DIR/lib" \
            -p @executable_path/../lib

          # Fix any duplicate LC_RPATH entries (can cause dyld errors)
          install_name_tool -delete_rpath @executable_path/../lib "$INSTALL_DIR/bin/magick" 2>/dev/null || true
          install_name_tool -add_rpath @executable_path/../lib "$INSTALL_DIR/bin/magick" 2>/dev/null || true

          # Strip debug symbols to reduce size
          echo "=== Stripping debug symbols ==="
          strip -x "$INSTALL_DIR/bin/magick" 2>/dev/null || true
          find "$INSTALL_DIR/lib" -name "*.dylib" -exec strip -x {} \; 2>/dev/null || true

          # Verify the binary works standalone
          echo "=== Verifying bundled binary ==="
          otool -L "$INSTALL_DIR/bin/magick"

      - name: Smoke test
        run: |
          INSTALL_DIR="${{ github.workspace }}/install"

          echo "=== Format Support Check ==="
          "$INSTALL_DIR/bin/magick" -list format | head -50

          for fmt in PNG JPEG WEBP HEIC PDF; do
            if "$INSTALL_DIR/bin/magick" -list format | grep -qi "$fmt"; then
              echo "✓ $fmt support verified"
            else
              echo "✗ WARNING: $fmt support not found"
            fi
          done

      - name: Create portable bundle
        env:
          VERSION: ${{ needs.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          BUNDLE_DIR="imagemagick-${VERSION}-macos-${ARCH}"
          mkdir -p "$BUNDLE_DIR"

          # Copy essential files
          cp -r ${{ github.workspace }}/install/bin "$BUNDLE_DIR/"
          cp -r ${{ github.workspace }}/install/lib "$BUNDLE_DIR/"
          cp -r ${{ github.workspace }}/install/etc "$BUNDLE_DIR/" 2>/dev/null || true
          mkdir -p "$BUNDLE_DIR/share"
          cp -r ${{ github.workspace }}/install/share/ImageMagick-7 "$BUNDLE_DIR/share/" 2>/dev/null || true

          # Add license
          cp ImageMagick/LICENSE "$BUNDLE_DIR/LICENSE.txt"

          # Remove unnecessary files to reduce size
          find "$BUNDLE_DIR" -name "*.a" -delete 2>/dev/null || true
          find "$BUNDLE_DIR" -name "*.la" -delete 2>/dev/null || true
          find "$BUNDLE_DIR" -name "pkgconfig" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$BUNDLE_DIR" -name "cmake" -type d -exec rm -rf {} + 2>/dev/null || true
          find "$BUNDLE_DIR" -name "*.h" -delete 2>/dev/null || true
          find "$BUNDLE_DIR" -name "include" -type d -exec rm -rf {} + 2>/dev/null || true

          # Show size before tarball
          echo "=== Bundle size ==="
          du -sh "$BUNDLE_DIR"
          du -sh "$BUNDLE_DIR/bin" "$BUNDLE_DIR/lib"

          # Create tarball
          tar -czvf "${BUNDLE_DIR}.tar.gz" "$BUNDLE_DIR"
          shasum -a 256 "${BUNDLE_DIR}.tar.gz" > "${BUNDLE_DIR}.sha256"

          echo "=== Bundle created ==="
          ls -la "${BUNDLE_DIR}."*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-${{ needs.version.outputs.version }}-macos-${{ matrix.arch }}
          path: |
            imagemagick-*.tar.gz
            imagemagick-*.sha256

  # ============================================================================
  # RELEASE PUBLISHING
  # Creates/updates a rolling prerelease with all artifacts
  # ============================================================================
  release:
    name: Publish Release
    runs-on: ubuntu-24.04
    if: github.event_name != 'pull_request'
    needs:
      - version
      - windows
      - linux-glibc
      - linux-musl
      - macos

    permissions:
      contents: write

    steps:
      - name: Clone this repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.tar.gz" -o -name "*.sha256" | sort
          ls -la artifacts/

      - name: Create/Update rolling release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.version.outputs.version }}
          IM_COMMIT: ${{ needs.version.outputs.commit }}
          WRAPPER_COMMIT: ${{ github.sha }}
          PLATFORM_WINDOWS: ${{ github.event.inputs.platform_windows != 'false' && 'true' || 'false' }}
          PLATFORM_LINUX_GLIBC: ${{ github.event.inputs.platform_linux_glibc != 'false' && 'true' || 'false' }}
          PLATFORM_LINUX_MUSL: ${{ github.event.inputs.platform_linux_musl != 'false' && 'true' || 'false' }}
          PLATFORM_MACOS: ${{ github.event.inputs.platform_macos != 'false' && 'true' || 'false' }}
        run: |
          # Determine which platform files to replace
          PLATFORMS_TO_UPDATE=""
          [ "$PLATFORM_WINDOWS" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE windows"
          [ "$PLATFORM_LINUX_GLIBC" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE linux-glibc"
          [ "$PLATFORM_LINUX_MUSL" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE linux-musl"
          [ "$PLATFORM_MACOS" = "true" ] && PLATFORMS_TO_UPDATE="$PLATFORMS_TO_UPDATE macos"

          echo "Platforms to update: $PLATFORMS_TO_UPDATE"

          # Check if release exists
          if gh release view bin-main &>/dev/null; then
            echo "Release exists. Updating platform-specific assets..."

            # Download existing assets to preserve them
            mkdir -p existing_assets
            gh release download bin-main --dir existing_assets --pattern "*.tar.gz" --pattern "*.sha256" 2>/dev/null || true

            # Delete only the assets for platforms being rebuilt
            for platform in $PLATFORMS_TO_UPDATE; do
              echo "Removing old $platform assets..."
              gh release delete-asset bin-main --pattern "*-${platform}-*" --yes 2>/dev/null || true
            done

            # Upload new artifacts
            echo "Uploading new artifacts..."
            gh release upload bin-main artifacts/*.tar.gz artifacts/*.sha256 --clobber

            # Update release notes
            cat > release_notes.md << EOF
          # ImageMagick Portable Binaries

          **ImageMagick Version:** ${VERSION}
          **ImageMagick Commit:** [${IM_COMMIT}](https://github.com/ImageMagick/ImageMagick/commit/${IM_COMMIT})
          **Wrapper Repo Commit:** [${WRAPPER_COMMIT:0:7}](https://github.com/${{ github.repository }}/commit/${WRAPPER_COMMIT})
          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Included Platforms

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | \`imagemagick-${VERSION}-windows-x64.tar.gz\` |
          | Windows | x86 | \`imagemagick-${VERSION}-windows-x86.tar.gz\` |
          | Linux (glibc) | amd64 | \`imagemagick-${VERSION}-linux-glibc-amd64.tar.gz\` |
          | Linux (glibc) | arm64 | \`imagemagick-${VERSION}-linux-glibc-arm64.tar.gz\` |
          | Linux (musl) | amd64 | \`imagemagick-${VERSION}-linux-musl-amd64.tar.gz\` |
          | Linux (musl) | arm64 | \`imagemagick-${VERSION}-linux-musl-arm64.tar.gz\` |
          | macOS | arm64 | \`imagemagick-${VERSION}-macos-arm64.tar.gz\` |
          | macOS | x64 | \`imagemagick-${VERSION}-macos-x64.tar.gz\` |

          ## Supported Formats
          PNG, JPEG, WEBP, HEIF/HEIC, PDF, TIFF, OpenJPEG (JP2)

          ## Notes
          - Built with Q16-HDRI quantum depth
          - Static builds for maximum portability
          - Minimal bundle size optimized for Node.js binary wrapper use
          - Updated platforms: $PLATFORMS_TO_UPDATE
          EOF

            gh release edit bin-main --notes-file release_notes.md

          else
            echo "Release does not exist. Creating new release..."

            # Create release notes
            cat > release_notes.md << EOF
          # ImageMagick Portable Binaries

          **ImageMagick Version:** ${VERSION}
          **ImageMagick Commit:** [${IM_COMMIT}](https://github.com/ImageMagick/ImageMagick/commit/${IM_COMMIT})
          **Wrapper Repo Commit:** [${WRAPPER_COMMIT:0:7}](https://github.com/${{ github.repository }}/commit/${WRAPPER_COMMIT})
          **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Included Platforms

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | \`imagemagick-${VERSION}-windows-x64.tar.gz\` |
          | Windows | x86 | \`imagemagick-${VERSION}-windows-x86.tar.gz\` |
          | Linux (glibc) | amd64 | \`imagemagick-${VERSION}-linux-glibc-amd64.tar.gz\` |
          | Linux (glibc) | arm64 | \`imagemagick-${VERSION}-linux-glibc-arm64.tar.gz\` |
          | Linux (musl) | amd64 | \`imagemagick-${VERSION}-linux-musl-amd64.tar.gz\` |
          | Linux (musl) | arm64 | \`imagemagick-${VERSION}-linux-musl-arm64.tar.gz\` |
          | macOS | arm64 | \`imagemagick-${VERSION}-macos-arm64.tar.gz\` |
          | macOS | x64 | \`imagemagick-${VERSION}-macos-x64.tar.gz\` |

          ## Supported Formats
          PNG, JPEG, WEBP, HEIF/HEIC, PDF, TIFF, OpenJPEG (JP2)

          ## Notes
          - Built with Q16-HDRI quantum depth
          - Static builds for maximum portability
          - Minimal bundle size optimized for Node.js binary wrapper use
          EOF

            # Create new prerelease
            gh release create bin-main \
              --title "ImageMagick ${VERSION} Portable Binaries" \
              --notes-file release_notes.md \
              artifacts/*.tar.gz \
              artifacts/*.sha256
          fi

  # ============================================================================
  # FAILURE HANDLER
  # Cancels the entire workflow if any job fails
  # ============================================================================
  cancel-on-failure:
    name: Cancel on Failure
    runs-on: ubuntu-24.04
    if: failure()
    needs:
      - windows
      - linux-glibc
      - linux-musl
      - macos

    steps:
      - name: Cancel workflow run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "A job failed. Cancelling workflow run..."
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
